name: Daily JSL LOF Analysis and Email

on:
  # 配置计划触发器
  schedule:
    # UTC 6:45 是北京时间 14:45
    - cron: '45 6 * * *'
  # 允许手动触发，方便测试
  workflow_dispatch:

jobs:
  run-script-and-send-email:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # 设置 Python 环境
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x' # 使用最新的 Python 3.x 版本

    # 安装脚本依赖
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run jsl_lof_analysis.py and capture output
      id: run_script
      run: |
        # 运行 Python 脚本并捕获其标准输出和标准错误
        OUTPUT=$(python jsl_lof_analysis.py 2>&1)
        echo "output<<EOF" >> $GITHUB_ENV
        echo "$OUTPUT" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Send email with output
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        # 对于 163 邮箱，通常需要开启 SSL
        secure: true # 启用 SSL/TLS
        username: ${{ secrets.EMAIL_ADDRESS }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: Daily JSL LOF Analysis Report - ${{ github.repository }} - ${{ github.run_number }}
        to: ${{ secrets.RECIPIENT_EMAIL }}
        from: ${{ secrets.EMAIL_ADDRESS }}
        # 邮件正文使用脚本的输出
        body: |
          Hello,
          关注基金：

          --- Script Output ---
          ${{ env.output }}
          --- End of Output ---

          Best regards,
          GitHub Actions